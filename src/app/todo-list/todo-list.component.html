<section class="w-full max-w-md mx-auto">
  <h2 class="text-2xl font-semibold mb-4">Mes t√¢ches</h2>

  <p>
    Aujourd‚Äôhui : {{ today | date:'fullDate' }}
  </p>
  <p>
    Exemple majuscule : {{ 'bonjour' | uppercase }}
  </p>
  <p>
    Pourcentage : {{ 0.376 | percent:'1.0-2' }}
  </p>

  <form
    class="flex gap-2 mb-4"
    (submit)="add(task.value, deadline.value); task.value=''; deadline.value=''; $event.preventDefault()"
  >
    <input
      #task
      class="flex-1 border p-2 rounded-lg"
      placeholder="Nouvelle t√¢che"
    />
    <input
      #deadline
      type="date"
      class="border p-2 rounded-lg"
      style="width: 160px"
      placeholder="√âch√©ance"
    />
    <button
      type="submit"
      class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
    >
      Ajouter
    </button>
  </form>

  <p *ngIf="!hasTodos" class="italic text-gray-500">Aucune t√¢che</p>

  <!-- Champ recherche s√©par√© -->
  <input
    type="text"
    [(ngModel)]="searchTerm"
    placeholder="Rechercher une t√¢che‚Ä¶"
    class="w-full border p-2 mb-4 rounded-lg"
  />

  <!-- Filtres statut -->
  <div class="flex gap-2 mb-4">
    <button
      class="px-2 py-1 rounded"
      [class.bg-blue-600]="filter === 'all'"
      [class.text-white]="filter === 'all'"
      (click)="filter = 'all'"
    >Toutes</button>
    <button
      class="px-2 py-1 rounded"
      [class.bg-blue-600]="filter === 'todo'"
      [class.text-white]="filter === 'todo'"
      (click)="filter = 'todo'"
    >√Ä faire</button>
    <button
      class="px-2 py-1 rounded"
      [class.bg-blue-600]="filter === 'done'"
      [class.text-white]="filter === 'done'"
      (click)="filter = 'done'"
    >Termin√©es</button>
  </div>

  <!-- Filtres tri + Archivage -->
  <div class="flex gap-2 mb-4 flex-wrap">
    <button
      class="px-2 py-1 rounded"
      [class.bg-purple-600]="sort === 'none'"
      [class.text-white]="sort === 'none'"
      (click)="sort = 'none'"
    >Ordre original</button>
    <button
      class="px-2 py-1 rounded"
      [class.bg-purple-600]="sort === 'date'"
      [class.text-white]="sort === 'date'"
      (click)="sort = 'date'"
    >Par date d‚Äô√©ch√©ance</button>
    <button
      class="px-2 py-1 rounded"
      [class.bg-purple-600]="sort === 'alpha'"
      [class.text-white]="sort === 'alpha'"
      (click)="sort = 'alpha'"
    >Alphab√©tique</button>
    <button
      class="px-3 py-1 rounded bg-gray-600 text-white hover:bg-gray-800"
      (click)="archiveDone()"
      [disabled]="!hasDoneNotArchived"
      title="Archive toutes les t√¢ches termin√©es"
    >
      Archiver les t√¢ches termin√©es
    </button>
  </div>

  <!-- Liste des t√¢ches (hors archiv√©es) -->
  <ul>
    <li
      *ngFor="let t of filteredTodos"
      class="py-1 hover:bg-slate-100 flex items-center justify-between"
    >
      <div class="flex items-center flex-1 min-w-0">
        <!-- Checkbox de compl√©tion -->
        <input
          type="checkbox"
          [checked]="t.done"
          (change)="toggle(t)"
          class="mr-2 accent-green-600"
          [disabled]="editId === t.id"
          title="Marquer comme termin√©e"
        />

        <!-- Mode √©dition ou affichage -->
        <ng-container *ngIf="editId !== t.id; else editMode">
          <span
            (dblclick)="startEdit(t.id)"
            [class.line-through]="t.done"
            [class.text-gray-400]="t.done"
            [class.text-red-600]="t.deadline && !t.done && t.deadline < today"
            class="truncate"
            title="Double-clique pour √©diter"
          >
            <span [innerHTML]="t.label | capitalize | highlight:searchTerm"></span>
            <span class="text-xs text-gray-500 ml-2">
              ({{ t.createdAt | date:'shortTime' }})
              <ng-container *ngIf="t.deadline">
                | √âch√©ance‚ÄØ:
                <span [class.text-red-600]="!t.done && t.deadline < today">
                  {{ t.deadline | date:'dd/MM/yyyy' }}
                </span>
              </ng-container>
            </span>
          </span>
        </ng-container>
        <ng-template #editMode>
          <form
            class="flex-1 flex gap-2"
            (submit)="saveEdit(t, editInput, editDate); $event.preventDefault()"
          >
            <input
              #editInput
              [value]="t.label"
              class="flex-1 border p-1 rounded"
              (blur)="saveEdit(t, editInput, editDate)"
              autofocus
            />
            <input
              #editDate
              type="date"
              [value]="t.deadline ? (t.deadline | date:'yyyy-MM-dd') : ''"
              class="border p-1 rounded w-32"
            />
            <button type="submit" class="text-green-600 hover:text-green-800">‚úîÔ∏è</button>
            <button type="button" (click)="endEdit()" class="text-gray-600 ml-1">‚úñÔ∏è</button>
          </form>
        </ng-template>
      </div>
      <button
        type="button"
        (click)="openConfirmation('deleteOneActive', t.id); $event.stopPropagation()"
        class="ml-2 text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100 transition"
        title="Supprimer"
      >üóëÔ∏è</button>
    </li>
  </ul>

  <!-- R√©capitulatif -->
  <p class="mt-4 text-sm text-gray-600">
    {{ filteredTodos.length }} t√¢che(s) affich√©e(s) |
    {{ todoService.remaining() }} √† faire |
    {{ archivedCount }} archiv√©es |
    {{ todoService.todos().length }} cr√©√©es au total
  </p>

  <!-- Affichage/Masquage des archives -->
  <button
    class="px-2 py-1 rounded bg-gray-300 hover:bg-gray-400 mt-2"
    (click)="showArchives = !showArchives"
    *ngIf="archivedCount"
  >
    {{ showArchives ? 'Masquer' : 'Afficher' }} les archives ({{ archivedCount }})
  </button>

  <!-- Actions globales sur les archives -->
  <div *ngIf="showArchives && archivedCount" class="mb-2 flex gap-2">
    <button
      class="px-2 py-1 rounded bg-red-200 hover:bg-red-400 text-red-800"
      (click)="openConfirmation('deleteAll')"
    >Supprimer toutes les archives</button>
  </div>

  <!-- Liste des archives -->
  <ul *ngIf="showArchives && archivedCount">
    <li *ngFor="let t of archivedTodos"
        class="line-through text-gray-400 text-sm pl-2 flex items-center justify-between">
      <div>
        <span [innerHTML]="t.label | capitalize | highlight:searchTerm"></span>
        <span class="text-xs text-gray-500 ml-2">
          (cr√©√©e le {{ t.createdAt | date:'dd/MM/yyyy' }})
          <ng-container *ngIf="t.deadline">
            | √©ch√©ance : {{ t.deadline | date:'dd/MM/yyyy' }}
          </ng-container>
        </span>
      </div>
      <div class="flex gap-1">
        <button
          class="text-blue-600 hover:text-blue-800 rounded px-1"
          (click)="unarchive(t.id)"
          title="D√©sarchiver"
        >‚ôªÔ∏è</button>
        <button
          class="text-red-600 hover:text-red-800 rounded px-1"
          (click)="openConfirmation('deleteOne', t.id)"
          title="Supprimer d√©finitivement"
        >üóëÔ∏è</button>
      </div>
    </li>
  </ul>

  <!-- Modale/Banni√®re de confirmation personnalis√©e -->
  <div *ngIf="confirmation.action" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 shadow-xl w-full max-w-xs text-center flex flex-col items-center">
      <div class="mb-3 text-lg font-semibold">
        <ng-container [ngSwitch]="confirmation.action">
          <span *ngSwitchCase="'deleteOneActive'">Supprimer d√©finitivement cette t√¢che‚ÄØ?</span>
          <span *ngSwitchCase="'deleteOne'">Supprimer d√©finitivement cette t√¢che archiv√©e‚ÄØ?</span>
          <span *ngSwitchCase="'deleteAll'">Supprimer TOUTES les t√¢ches archiv√©es‚ÄØ?</span>
        </ng-container>
      </div>
      <div class="flex gap-3 mt-2">
        <button (click)="validateConfirmation()"
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
          Oui, supprimer
        </button>
        <button (click)="closeConfirmation()"
                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
          Annuler
        </button>
      </div>
    </div>
  </div>
</section>
